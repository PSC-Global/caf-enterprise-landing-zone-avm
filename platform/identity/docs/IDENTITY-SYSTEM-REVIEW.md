# Identity System Review & Pipeline Documentation

## ğŸ“ File Structure Analysis

### âœ… **Required Source Files** (Must Keep)

#### Configuration Files
```
platform/identity/config/
â”œâ”€â”€ capabilities/
â”‚   â”œâ”€â”€ ai.yaml                    âœ… Defines AI capability roles
â”‚   â”œâ”€â”€ compute.yaml               âœ… Defines compute capability roles
â”‚   â”œâ”€â”€ data.yaml                  âœ… Defines data capability roles
â”‚   â”œâ”€â”€ security.yaml              âœ… Defines security capability roles
â”‚   â”œâ”€â”€ network.yaml               âœ… Defines network capability roles
â”‚   â”œâ”€â”€ storage.yaml               âœ… Defines storage capability roles
â”‚   â”œâ”€â”€ governance.yaml            âœ… Defines governance capability roles
â”‚   â”œâ”€â”€ identity.yaml              âœ… Defines identity capability roles
â”‚   â”œâ”€â”€ monitoring.yaml            âœ… Defines monitoring capability roles
â”‚   â”œâ”€â”€ integration.yaml           âœ… Defines integration capability roles
â”‚   â””â”€â”€ iot.yaml                   âœ… Defines IoT capability roles
â”‚
â””â”€â”€ projects/
    â”œâ”€â”€ fraud-engine.yaml          âœ… Project configuration
    â””â”€â”€ lending-core.yaml          âœ… Project configuration
```

#### Source Bicep Files
```
platform/identity/bicep/
â”œâ”€â”€ role-assignments.bicep         âœ… Main RBAC deployment template
â””â”€â”€ role-definition-ids.json       âœ… Manual: Role name â†’ GUID mapping
```

#### Scripts
```
platform/identity/scripts/
â”œâ”€â”€ invoke-capability-access-pipeline.ps1    âœ… Orchestrator (main entry point)
â”œâ”€â”€ generate-capability-access.ps1           âœ… Step 1: Generate assignments
â”œâ”€â”€ sync-aad-groups.ps1                      âœ… Step 2: Sync AAD groups
â”œâ”€â”€ generate-bicepparam.ps1                  âœ… Step 3: Generate parameters
â”œâ”€â”€ deploy-role-assignments.ps1              âœ… Step 4: Deploy RBAC to Azure
â””â”€â”€ validate-role-mapping.ps1                âœ… Validates role mapping
```

#### Documentation
```
platform/identity/docs/
â”œâ”€â”€ IDENTITY-SYSTEM-REVIEW.md      âœ… System architecture and pipeline documentation
â”œâ”€â”€ QUICK-START.md                 âœ… Quick reference guide for running the pipeline
â””â”€â”€ CAPABILITY-CATALOGUE.md        âœ… Reference for all capabilities and role mappings
```

---

### ğŸ”„ **Generated Files** (Auto-generated by Pipeline)

These files are created/updated by the pipeline and should be **committed to source control** for visibility and reproducibility:

```
platform/identity/bicep/
â”œâ”€â”€ generated-role-assignments.json    âœ… Generated: All computed role assignments
â”œâ”€â”€ aad-group-ids.bicepparam          âœ… Generated: Bicep parameter file
â””â”€â”€ aad-group-ids.json                âœ… Generated: JSON for Azure CLI

platform/identity/config/
â””â”€â”€ aad-group-mapping.json            âœ… Generated: AAD group name â†’ ObjectId mapping
```

---

## ğŸ”„ Pipeline Flow Explained

### High-Level Flow

```
1. Define Capabilities (YAML)  â†’  2. Define Projects (YAML)  â†’  3. Run Pipeline  â†’  4. Deploy RBAC
     (Manual)                         (Manual)                  (Automated)          (Azure CLI)
```

### Detailed Step-by-Step Flow

#### **STEP 1: Configuration (Manual)**

1. **Define Capabilities** (`config/capabilities/*.yaml`)
   - Each file defines role mappings for a capability
   - Structure: `capability: <name>`, `accessLevels: {reader: [...], contributor: [...], admin: [...]}`
   - Example: `compute.yaml` maps "contributor" level to multiple Azure roles

2. **Define Projects** (`config/projects/*.yaml`)
   - Each file defines which capabilities a project uses per environment
   - Structure: `project: <name>`, `environments: {<env>: {scope, subscriptionId, resourceGroup, capabilities: {...}}}`
   - Example: `fraud-engine.yaml` defines dev/sit/prd environments with compute, ai, data, security capabilities
   - **Note:** User membership is managed by IAM team separately; YAML only defines groups and RBAC

3. **Maintain Role Mapping** (`bicep/role-definition-ids.json`)
   - Manual file mapping role names to Azure GUIDs
   - Example: `"Virtual Machine Contributor": "9980e02c-c2be-4d73-94e8-173b1dc7cf3c"`
   - When adding new roles, fetch GUID from Azure and add here

---

#### **STEP 2: Run Pipeline (Automated)**

The orchestrator (`invoke-capability-access-pipeline.ps1`) runs these steps:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Validate Role Mapping                                â”‚
â”‚    â””â”€> Checks for duplicate roles/GUIDs                 â”‚
â”‚        Script: validate-role-mapping.ps1                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Generate Role Assignments                            â”‚
â”‚    â””â”€> Reads: capabilities/*.yaml + projects/*.yaml    â”‚
â”‚        Outputs: generated-role-assignments.json         â”‚
â”‚        Script: generate-capability-access.ps1           â”‚
â”‚                                                          â”‚
â”‚    Example output entry:                                â”‚
â”‚    {                                                     â”‚
â”‚      "project": "fraud-engine",                         â”‚
â”‚      "environment": "dev",                              â”‚
â”‚      "capability": "compute",                           â”‚
â”‚      "level": "contributor",                            â”‚
â”‚      "role": "Virtual Machine Contributor",             â”‚
â”‚      "aadGroupName": "rai-fraud-engine-dev-compute-     â”‚
â”‚                       contributor",                     â”‚
â”‚      "scopeType": "subscription",                       â”‚
â”‚      "scopeValue": "<subscription-id>"                  â”‚
â”‚    }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Sync AAD Groups                                      â”‚
â”‚    â””â”€> Reads: project YAML files                        â”‚
â”‚        Finds/creates AAD groups in Azure AD             â”‚
â”‚        Group naming: rai-<project>-<env>-<capability>-<level> â”‚
â”‚        Outputs: aad-group-mapping.json                  â”‚
â”‚        Script: sync-aad-groups.ps1                      â”‚
â”‚                                                          â”‚
â”‚    Example output:                                      â”‚
â”‚    {                                                     â”‚
â”‚      "rai-fraud-engine-dev-compute-contributor":        â”‚
â”‚        "1ac93091-ff2a-4bee-aec9-32c31c555897"          â”‚
â”‚    }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Generate Bicep Parameters                            â”‚
â”‚    â””â”€> Reads: aad-group-mapping.json                    â”‚
â”‚        Outputs:                                          â”‚
â”‚          - aad-group-ids.bicepparam (Bicep format)      â”‚
â”‚          - aad-group-ids.json (JSON format)             â”‚
â”‚        Script: generate-bicepparam.ps1                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **STEP 3: Deploy to Azure (Manual)**

```bash
# Set active subscription
az account set --subscription <subscription-id>

# Deploy role assignments
az deployment sub create \
  --location australiaeast \
  --template-file platform/identity/bicep/role-assignments.bicep \
  --parameters assignments=@platform/identity/bicep/generated-role-assignments.json \
  --parameters aadGroupIds=@platform/identity/bicep/aad-group-ids.json
```

**What happens during deployment:**
1. Bicep loads `role-definition-ids.json` to map role names â†’ GUIDs
2. For each assignment in `generated-role-assignments.json`:
   - Looks up role GUID from mapping
   - Looks up AAD group ObjectId from `aadGroupIds` parameter
   - Creates RBAC role assignment at subscription scope

---

## ğŸš€ How to Run the Pipeline

### Prerequisites

1. **PowerShell 7+** installed
2. **Azure CLI** installed and authenticated
3. **Az.Accounts** module (for Azure CLI integration)
4. **ConvertFrom-Yaml** module (if using YAML parsing):
   ```powershell
   Install-Module -Name powershell-yaml -Scope CurrentUser
   ```

### Running the Full Pipeline

```powershell
# Navigate to scripts directory
cd platform/identity/scripts

# Run for all projects
.\invoke-capability-access-pipeline.ps1

# Or run for specific projects only
.\invoke-capability-access-pipeline.ps1 -Projects "fraud-engine,lending-core"
```

### Pipeline Output

After successful run, you'll see:
```
âœ“ Validation passed! (43 roles, 43 GUIDs)
Generated role assignment file: .../generated-role-assignments.json
AAD mapping file updated: .../aad-group-mapping.json
Generated: .../aad-group-ids.bicepparam
Generated: .../aad-group-ids.json
Pipeline complete
```

### Running Individual Steps

If you need to run steps individually:

```powershell
# Step 1: Validate mapping
.\validate-role-mapping.ps1

# Step 2: Generate assignments
.\generate-capability-access.ps1 -Projects @("fraud-engine")

# Step 3: Sync AAD groups
.\sync-aad-groups.ps1

# Step 4: Generate parameters
.\generate-bicepparam.ps1
```

---

## ğŸ“‹ File Purpose Summary

| File | Type | Purpose | Generated? |
|------|------|---------|------------|
| `config/capabilities/*.yaml` | Source | Defines role catalog per capability | âŒ Manual |
| `config/projects/*.yaml` | Source | Defines project capability access | âŒ Manual |
| `bicep/role-definition-ids.json` | Source | Maps role names to GUIDs | âŒ Manual |
| `bicep/role-assignments.bicep` | Source | RBAC deployment template | âŒ Manual |
| `bicep/generated-role-assignments.json` | Generated | Computed assignments for deployment | âœ… Pipeline |
| `bicep/aad-group-ids.bicepparam` | Generated | Bicep parameter file | âœ… Pipeline |
| `bicep/aad-group-ids.json` | Generated | JSON parameter for Azure CLI | âœ… Pipeline |
| `config/aad-group-mapping.json` | Generated | AAD group name â†’ ObjectId mapping | âœ… Pipeline |
| `bicep/role-assignments.json` | **REDUNDANT** | Compiled ARM JSON (not used) | âŒ Delete |

---

## ğŸ§¹ Recommended Cleanup

1. **Delete redundant file:**
   ```bash
   rm platform/identity/bicep/role-assignments.json
   ```

2. **Add to `.gitignore`** (optional, to prevent future commits):
   ```
   # Compiled Bicep outputs (if not already ignored)
   platform/identity/bicep/*.json
   !platform/identity/bicep/generated-role-assignments.json
   !platform/identity/bicep/aad-group-ids.json
   !platform/identity/bicep/role-definition-ids.json
   ```

---

## âœ… Validation Checklist

Before deploying, verify:
- [ ] All capability YAML files are valid
- [ ] All project YAML files have correct subscription IDs
- [ ] Role mapping file has no duplicates (pipeline validates this)
- [ ] All role names in capabilities exist in `role-definition-ids.json`
- [ ] Pipeline completes without errors
- [ ] Generated files are present and valid JSON

---

## ğŸ”— Key Concepts

### Capability Model
- **Capabilities** = Technical domains (compute, data, security, etc.)
- **Projects** = Business applications (fraud-engine, lending-core, etc.)
- **Environments** = Deployment stages (dev, sit, prd)
- **Access Levels** = Permission tiers (reader, contributor, admin)

### Naming Convention
AAD groups follow: `rai-<project>-<env>-<capability>-<level>`
- Example: `rai-fraud-engine-dev-compute-contributor`
- Example: `rai-lending-core-sit-data-viewer`

### Scope Model
- **Subscriptions** = Where projects live
- **Resource Groups** = Where environments are deployed
- **RBAC Assignments** = Applied at subscription scope (can be scoped down)

