# IPAM State Management

This directory contains generated IPAM allocation state files.

## Files

- `ipam-state.json` - Active state file tracking all CIDR allocations (generated by `ipam-allocate.ps1`)
- `ipam-state.json.example` - Example state file format for reference

## State File Format

The `ipam-state.json` file tracks all CIDR block allocations:

```json
{
  "lastUpdated": "2024-01-15T10:00:00Z",
  "allocations": [
    {
      "allocationKey": "rai-lending-core-prod-01-workload",
      "cidr": "10.1.5.0/24",
      "cidrSize": 24,
      "space": "rai",
      "block": "rai-spokes-aue-prod",
      "allocatedAt": "2024-01-15T10:00:00Z",
      "status": "allocated"
    }
  ]
}
```

### Fields

- **allocationKey**: Unique identifier for the allocation (format: `<subscription-alias>-<purpose>`)
- **cidr**: Allocated CIDR block (e.g., `10.1.5.0/24`)
- **cidrSize**: CIDR prefix size (e.g., `24` for `/24`)
- **space**: IPAM space name (e.g., `rai`)
- **block**: IPAM block name (e.g., `rai-spokes-aue-prod`)
- **allocatedAt**: ISO 8601 timestamp when allocation was made
- **status**: Allocation status (`allocated` or `released`)

## Usage

The state file is automatically managed by `ipam-allocate.ps1`. You should not manually edit this file.

### Viewing Allocations

```powershell
Get-Content ../generated/ipam-state.json | ConvertFrom-Json | Select-Object -ExpandProperty allocations
```

### Releasing an Allocation

```powershell
./ipam-allocate.ps1 -AllocationKey "rai-lending-core-prod-01-workload" -Release
```

## Future Azure IPAM Integration

The state file format is designed to be compatible with future Azure IPAM API integration. When Azure IPAM is deployed, the `ipam-allocate.ps1` script can be updated to:

1. Check Azure IPAM API first
2. Fall back to local state if API unavailable
3. Sync local state with Azure IPAM for backup

## Backup Recommendations

- Commit `ipam-state.json` to version control (or exclude if contains sensitive data)
- Regular backups before major network changes
- Export state before decommissioning subscriptions
