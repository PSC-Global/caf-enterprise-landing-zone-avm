# Phases 3 & 4 — vWAN Secure Hub & Spoke VNets: Implementation Summary

## Overview

Phases 3 and 4 implement the secure networking fabric with forced egress through Azure Firewall and standardized spoke VNet deployments.

## Phase 3 — vWAN Secure Hub (Core Network Fabric)

### Phase 3.1 — vWAN + vHub Baseline ✅

**File**: `platform/connectivity/bicep/vwan-hub.bicep`

- ✅ Added `vwanId` output (alias for `virtualWanResourceId`)
- ✅ Added `vhubId` output (alias for `virtualHubResourceId`)
- ✅ Maintains backward compatibility with existing outputs

### Phase 3.2 — Azure Firewall + Diagnostics ✅

**Files**:
- `platform/connectivity/bicep/firewall-policy.bicep` (new)
- `platform/connectivity/bicep/vwan-hub.bicep` (updated)

**Firewall Policy Module**:
- ✅ Creates Azure Firewall Policy (using native Bicep - AVM not available)
- ✅ Supports Standard/Premium tiers
- ✅ Threat Intelligence mode configuration
- ✅ DNS Proxy and DNS over HTTPS support
- ✅ Diagnostic settings for firewall policy
- ✅ Outputs `firewallPolicyResourceId`

**vWAN Hub Updates**:
- ✅ Creates firewall policy automatically if not provided
- ✅ Attaches firewall policy to Azure Firewall
- ✅ Diagnostic settings for:
  - Virtual WAN
  - Virtual Hub
  - Azure Firewall
  - Firewall Policy (in firewall-policy.bicep)
- ✅ All diagnostics send to `logAnalyticsWorkspaceResourceId`

**Integration**:
- ✅ `deploy-connectivity.ps1` updated to retrieve LAW ID from central logging (Phase 1)
- ✅ LAW ID automatically passed to vwan-hub deployment

### Phase 3.3 — Forced Egress (Route Intent) ✅

**File**: `platform/connectivity/bicep/route-intent.bicep` (new)

**Implementation**:
- ✅ Creates Routing Intent resource
  - Routes internet traffic (0.0.0.0/0) through Azure Firewall
  - Applies to all vWAN-connected spokes
- ✅ Creates Route Table (`hubRouteTables`)
  - Reusable route table for VNet connection associations
  - Default route to firewall for forced egress
- ✅ Integrated into `vwan-hub.bicep` when firewall enabled
- ✅ Outputs `routingIntentResourceId` and `routeTableResourceId`

**Usage**:
- Automatically deployed when `enableFirewall=true` and `enableForcedEgress=true` (default)
- Route table can be associated with individual VNet connections for granular control

---

## Phase 4 — Spoke VNets (Landing Zones)

### Phase 4.1 — Spoke VNet Module with Profiles ✅

**File**: `platform/connectivity/bicep/spoke-vnet.bicep`

- ✅ Added `subnetProfileName` parameter (for documentation/reference)
- ✅ Subnets are generated by `deploy-connectivity.ps1` from subnet-blueprints.json
- ✅ Backward compatible - subnets array parameter still works
- ✅ Supports route table association for forced egress

**Integration**:
- Script already loads subnet profiles and generates subnets (Phase 2.1)
- Subnets passed to Bicep module as array
- Profile name parameter added for clarity/documentation

### Phase 4.2 — Spoke → vHub Connection ✅

**Files**:
- `platform/connectivity/bicep/vnet-connection.bicep` (new)
- `platform/connectivity/bicep/spoke-vnet.bicep` (updated)

**vnet-connection.bicep**:
- ✅ Connects spoke VNet to vHub
- ✅ Associates route table for forced egress
- ✅ Configurable transit settings
- ✅ Outputs connection ID

**spoke-vnet.bicep Updates**:
- ✅ Updated hub connection to support route table association
- ✅ Uses `routingConfiguration` for route table association
- ✅ Maintains backward compatibility (route table optional)

**Integration**:
- ✅ `deploy-connectivity.ps1` retrieves route table from hub deployment
- ✅ Automatically associates route table with spoke VNet connection
- ✅ Forces all internet traffic (0.0.0.0/0) through hub firewall

---

## Files Created/Modified

### Created
- `platform/connectivity/bicep/firewall-policy.bicep` - Firewall Policy module
- `platform/connectivity/bicep/route-intent.bicep` - Route Intent for forced egress
- `platform/connectivity/bicep/vnet-connection.bicep` - Standalone VNet connection module
- `platform/connectivity/docs/PHASE3-4-IMPLEMENTATION.md` - This file

### Modified
- `platform/connectivity/bicep/vwan-hub.bicep` - Added firewall policy, diagnostics, route intent
- `platform/connectivity/bicep/spoke-vnet.bicep` - Added route table association support
- `platform/connectivity/scripts/deploy-connectivity.ps1` - Integrated central LAW, route table retrieval

---

## Usage Examples

### Deploy Secure Hub

```powershell
cd platform/connectivity/scripts
./deploy-connectivity.ps1 -SubscriptionId "rai-platform-connectivity-prod-01"
```

**What happens:**
1. Deploys Virtual WAN and Virtual Hub
2. Creates Firewall Policy
3. Deploys Azure Firewall with policy attached
4. Creates Route Intent (forced egress)
5. Creates Route Table for VNet connections
6. Enables diagnostics for all resources → Central LAW

### Deploy Spoke VNet with Forced Egress

```powershell
./deploy-connectivity.ps1 -SubscriptionId "rai-lending-core-prod-01"
```

**What happens:**
1. Allocates CIDR via IPAM (Phase 2.2)
2. Generates subnets from `spoke.workload.standard` profile (Phase 2.1)
3. Deploys VNet with subnets
4. Retrieves route table from hub
5. Connects VNet to hub
6. Associates route table → All internet traffic routes through firewall

---

## Standard Outputs

### vWAN Hub Outputs
- `vwanId` / `virtualWanResourceId` - Virtual WAN ID
- `vhubId` / `virtualHubResourceId` - Virtual Hub ID
- `azureFirewallResourceId` - Azure Firewall ID
- `firewallPolicyResourceId` - Firewall Policy ID
- `routingIntentResourceId` - Routing Intent ID (if enabled)
- `routeTableResourceId` - Route Table ID (if enabled)

### Spoke VNet Outputs
- `resourceId` - VNet resource ID
- `hubConnectionResourceId` - Hub connection ID (if connected)
- `subnetResourceIds` - Array of subnet resource IDs

---

## Architecture

```
Virtual WAN
└── Virtual Hub (rai-platform-connectivity-prod-01)
    ├── Azure Firewall (with Firewall Policy)
    ├── Route Intent (0.0.0.0/0 → Firewall)
    └── Route Table (forced-egress)
        └── Associated with Spoke Connections

Spoke VNets (rai-lending-core-prod-01, etc.)
└── VNet with Subnets (from profiles)
    └── Hub Connection
        └── Route Table Association
            └── All Internet Traffic → Hub Firewall
```

---

## Key Features

1. **Centralized Security**: All internet egress forced through hub firewall
2. **Diagnostics**: All networking resources send logs to central LAW
3. **Automated**: Route table automatically discovered and associated
4. **Profile-Based**: Subnets generated from standardized profiles
5. **IPAM-Integrated**: Deterministic IP allocation (Phase 2)

---

## Validation

- ✅ All Bicep files compile successfully
- ✅ AVM modules used where available
- ✅ Native Bicep used for vWAN-specific features (route intent)
- ✅ Backward compatibility maintained
- ✅ Integration with Phase 1 (central logging) and Phase 2 (IPAM)

---

## Next Steps

1. Deploy hub: `./deploy-connectivity.ps1 -SubscriptionId "rai-platform-connectivity-prod-01"`
2. Deploy spokes: `./deploy-connectivity.ps1 -SubscriptionId "rai-lending-core-prod-01"`
3. Configure firewall rules in Firewall Policy
4. Verify forced egress: Test internet connectivity from spoke resources
